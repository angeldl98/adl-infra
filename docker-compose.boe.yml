networks:
  adl-net:
    driver: bridge

volumes:
  pgdata:
  logs-data:

services:
  postgres:
    image: postgres:15
    container_name: adl-postgres
    env_file:
      - /opt/adl-suite/data/secrets/runtime.env
    environment:
      POSTGRES_USER: adl
      POSTGRES_DB: adl_core
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "0.0.0.0:5432:5432"
    networks:
      - adl-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U adl"]
      interval: 10s
      timeout: 5s
    mem_limit: 1g
    cpus: 1.0

  adl-gateway:
    build:
      context: ..
      dockerfile: adl-gateway/Dockerfile
    container_name: adl-gateway
    env_file:
      - /opt/adl-suite/data/secrets/runtime.env
    environment:
      PORT: 4000
      SECRETS_URL: http://core-secrets:4202
      GATEWAY_POLICY_ENFORCE: ${GATEWAY_POLICY_ENFORCE:-1}
      GATEWAY_POLICY_ALLOW_ON_FAILURE: ${GATEWAY_POLICY_ALLOW_ON_FAILURE:-1}
      REDIS_PASSWORD_FILE: /opt/adl-suite/data/secrets/redis.password
    networks:
      - adl-net
    ports:
      - "4000:4000"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "node -e \"fetch('http://localhost:4000/health').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))\""]
      interval: 10s
      timeout: 5s
    mem_limit: 256m
    cpus: 0.5
    volumes:
      - logs-data:/opt/adl-suite/logs

  adl-web:
    build:
      context: ../adl-web
      dockerfile: Dockerfile
    container_name: adl-web
    env_file:
      - /opt/adl-suite/data/secrets/runtime.env
    environment:
      PORT: 3000
      NEXT_PUBLIC_API_BASE_URL: https://api.adlsuite.com
      APP_NAME: adl-web
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET:-change-this-in-production}
      NEXTAUTH_URL: ${NEXTAUTH_URL:-https://adlsuite.com}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: adl
      # POSTGRES_PASSWORD loaded from env_file (runtime.env)
      POSTGRES_DB: adl_core
      PREMIUM_EMAILS: ${PREMIUM_EMAILS:-angel.diaz.lopez98@gmail.com}
    networks:
      - adl-net
    depends_on:
      adl-gateway:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "node -e \"fetch('http://localhost:3000/api/health').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))\""]
      interval: 10s
      timeout: 5s
    mem_limit: 256m
    cpus: 0.5
    volumes:
      - logs-data:/opt/adl-suite/logs


# APPLICATION STACK
# This file is only started when repos are present and clean.
name: adl-infra-apps

volumes:
  logs-data:
    external: true
    name: adl-infra_logs-data
  pgdata:
    external: true
    name: adl-infra_pgdata
  secrets-data:
    external: true
    name: adl-infra_secrets-data

services:
  adl-gateway:
    build:
      context: ../adl-gateway
    container_name: adl-gateway
    env_file:
      - /opt/adl-suite/data/secrets/runtime.env
    environment:
      NODE_ENV: production
      PORT: 8080
    restart: unless-stopped
    networks:
      - adl-infra_adl-net

  adl-web:
    build:
      context: ../adl-web
    container_name: adl-web
    env_file:
      - /opt/adl-suite/data/secrets/runtime.env
    environment:
      NODE_ENV: production
    restart: unless-stopped
    networks:
      - adl-infra_adl-net

  boe-raw-runner:
    build:
      context: ../adl-boe-raw-scraper
    container_name: boe-raw-runner
    env_file:
      - /opt/adl-suite/data/secrets/runtime.env
    environment:
      DISABLE_PDF_PARSE: "true"
    restart: unless-stopped
    volumes:
      - /opt/adl-suite/data/boe_auth:/opt/adl-suite/data/boe_auth:ro
    networks:
      - adl-infra_adl-net

  boe-normalizer-runner:
    build:
      context: ../adl-boe-normalizer
    container_name: boe-normalizer-runner
    env_file:
      - /opt/adl-suite/data/secrets/runtime.env
    restart: unless-stopped
    networks:
      - adl-infra_adl-net
    # disabled: raw runner must succeed first
    deploy:
      replicas: 0

  pharma-raw-runner:
    build:
      context: ../adl-pharma-raw-scraper
    container_name: pharma-raw-runner
    env_file:
      - /opt/adl-suite/data/secrets/runtime.env
    restart: unless-stopped
    networks:
      - adl-infra_adl-net

  pharma-normalizer-runner:
    build:
      context: ../adl-pharma-normalizer
    container_name: pharma-normalizer-runner
    env_file:
      - /opt/adl-suite/data/secrets/runtime.env
    restart: unless-stopped
    networks:
      - adl-infra_adl-net
    # disabled: raw runner must succeed first
    deploy:
      replicas: 0

networks:
  adl-infra_adl-net:
    external: true


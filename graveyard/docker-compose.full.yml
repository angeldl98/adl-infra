networks:
  adl-net:
    driver: bridge

volumes:
  pgdata:
  secrets-data:
  logs-data:
  caddy_data:
  caddy_config:

services:
  postgres:
    image: postgres:15
    container_name: adl-postgres
    env_file:
      - /opt/adl-suite/data/secrets/runtime.env
    environment:
      POSTGRES_USER: adl
      POSTGRES_DB: adl_core
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "0.0.0.0:5432:5432"
    networks:
      - adl-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U adl"]
      interval: 10s
      timeout: 5s
      retries: 5
    mem_limit: 1g
    cpus: 1.0

  redis:
    image: redis:7-alpine
    container_name: adl-redis
    env_file:
      - /opt/adl-suite/data/secrets/runtime.env
    networks:
      - adl-net
    command: ["sh", "-c", "redis-server --requirepass \"$$REDIS_PASSWORD\""]
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -a \"$$REDIS_PASSWORD\" ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    mem_limit: 256m
    cpus: 0.5

  adl-gateway:
    build:
      context: ../adl-gateway
      dockerfile: Dockerfile
    container_name: adl-gateway
    env_file:
      - /opt/adl-suite/data/secrets/runtime.env
    environment:
      PORT: 4000
      SECRETS_URL: http://core-secrets:4202
      GATEWAY_POLICY_ENFORCE: ${GATEWAY_POLICY_ENFORCE:-1}
      GATEWAY_POLICY_ALLOW_ON_FAILURE: ${GATEWAY_POLICY_ALLOW_ON_FAILURE:-1}
      REDIS_PASSWORD_FILE: /opt/adl-suite/data/secrets/redis.password
    depends_on:
      adl-brain:
        condition: service_healthy
      adl-executor:
        condition: service_healthy
      adl-knowledge:
        condition: service_healthy
      adl-monitor:
        condition: service_healthy
      core-policy:
        condition: service_healthy
    networks:
      - adl-net
    ports:
      - "4000:4000"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "node -e \"fetch('http://localhost:4000/health').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))\""]
      interval: 10s
      timeout: 5s
      retries: 5
    mem_limit: 256m
    cpus: 0.5
    volumes:
      - logs-data:/opt/adl-suite/logs
      - secrets-data:/opt/adl-suite/data/secrets

  adl-brain:
    build:
      context: ../adl-brain
      dockerfile: Dockerfile
    container_name: adl-brain
    environment:
      PORT: 4001
      SECRETS_URL: http://core-secrets:4202
    networks:
      - adl-net
    depends_on:
      adl-executor:
        condition: service_healthy
      adl-knowledge:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "node -e \"fetch('http://localhost:4001/health').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))\""]
      interval: 10s
      timeout: 5s
      retries: 5
    mem_limit: 256m
    cpus: 0.5
    volumes:
      - logs-data:/opt/adl-suite/logs
      - secrets-data:/opt/adl-suite/data/secrets

  adl-executor:
    build:
      context: ../adl-executor
      dockerfile: Dockerfile
    container_name: adl-executor
    environment:
      PORT: 4002
      SECRETS_URL: http://core-secrets:4202
    networks:
      - adl-net
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    healthcheck:
      test: ["CMD-SHELL", "node -e \"fetch('http://localhost:4002/health').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))\""]
      interval: 10s
      timeout: 5s
      retries: 5
    mem_limit: 256m
    cpus: 0.5
    volumes:
      - logs-data:/opt/adl-suite/logs
      - secrets-data:/opt/adl-suite/data/secrets
      - /opt/adl-suite/sandbox:/opt/adl-suite/sandbox

  adl-monitor:
    build:
      context: ../adl-monitor
      dockerfile: Dockerfile
    container_name: adl-monitor
    environment:
      PORT: 4003
    networks:
      - adl-net
    depends_on:
      adl-executor:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "node -e \"fetch('http://localhost:4003/health').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))\""]
      interval: 10s
      timeout: 5s
      retries: 5
    mem_limit: 256m
    cpus: 0.5
    volumes:
      - logs-data:/opt/adl-suite/logs
      - /var/run/docker.sock:/var/run/docker.sock

  adl-knowledge:
    build:
      context: ../adl-knowledge
      dockerfile: Dockerfile
    container_name: adl-knowledge
    env_file:
      - /opt/adl-suite/data/secrets/runtime.env
    environment:
      PORT: 4004
      KNOWLEDGE_DATABASE_URL: postgres://adl:$(cat data/secrets/postgres.password)@postgres:5432/adl_knowledge
    networks:
      - adl-net
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "node -e \"fetch('http://localhost:4004/health').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))\""]
      interval: 10s
      timeout: 5s
      retries: 5
    mem_limit: 256m
    cpus: 0.5
    volumes:
      - logs-data:/opt/adl-suite/logs

  adl-web:
    build:
      context: ../adl-web
      dockerfile: Dockerfile
    container_name: adl-web
    env_file:
      - /opt/adl-suite/data/secrets/runtime.env
    environment:
      PORT: 3000
      NEXT_PUBLIC_API_URL: https://api.adlsuite.com
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET:-change-this-in-production}
      NEXTAUTH_URL: ${NEXTAUTH_URL:-https://adlsuite.com}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: adl
      # POSTGRES_PASSWORD loaded from env_file (runtime.env)
      POSTGRES_DB: adl_core
      PREMIUM_EMAILS: ${PREMIUM_EMAILS:-angel.diaz.lopez98@gmail.com}
    networks:
      - adl-net
    depends_on:
      adl-gateway:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "node -e \"fetch('http://localhost:3000/api/health').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))\""]
      interval: 10s
      timeout: 5s
      retries: 5
    mem_limit: 256m
    cpus: 0.5
    volumes:
      - logs-data:/opt/adl-suite/logs



  engine-scraper:
    build:
      context: ../engines/scraper
      dockerfile: Dockerfile
    container_name: engine-scraper
    env_file:
      - .env
      - /opt/adl-suite/data/secrets/runtime.env
    environment:
      PORT: 4103
      NODE_ENV: production
      PUPPETEER_EXECUTABLE_PATH: /usr/bin/chromium
      PLAYWRIGHT_BROWSERS_PATH: /ms-playwright
      PRISMA_SCHEMA_PATH: /app/prisma/schema.prisma
      ADL_API_DOMAIN: api.adlsuite.com
      ADL_DASHBOARD_DOMAIN: dashboard.adlsuite.com
      NEXT_PUBLIC_API_URL: https://api.adlsuite.com
      BOE_SUBASTAS_USERNAME: ${BOE_SUBASTAS_USERNAME}
      BOE_SUBASTAS_PASSWORD: ${BOE_SUBASTAS_PASSWORD}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4o}
      REDIS_PASSWORD_FILE: /opt/adl-suite/data/secrets/redis.password
      POSTGRES_PASSWORD_FILE: /opt/adl-suite/data/secrets/postgres.password
      GATEWAY_API_KEY_FILE: /opt/adl-suite/data/secrets/gateway.api_key
      ADMIN_EMAIL: ${ADMIN_EMAIL:-}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-}
    networks:
      - adl-net
    volumes:
      - logs-data:/opt/adl-suite/logs
      - /opt/adl-suite/data/sessions:/data/sessions
      - /opt/adl-suite/data:/opt/adl-suite/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "node -e \"fetch('http://localhost:4103/health').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))\""]
      interval: 10s
      timeout: 5s
      retries: 5
    mem_limit: 200m
    cpus: 0.4

  core-auth:
    build:
      context: ../core-auth
      dockerfile: Dockerfile
    container_name: core-auth
    restart: unless-stopped
    env_file:
      - /opt/adl-suite/data/secrets/runtime.env
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: adl
      POSTGRES_DB: adl_core
      ADMIN_EMAIL: ANGEL.DIAZ.LOPEZ98@GMAIL.COM
      ADMIN_PASSWORD: Temp#Adm1n-2025!
    depends_on:
      - postgres
    networks:
      - adl-net



  core-policy:
    build:
      context: ../core/core-policy
      dockerfile: Dockerfile
    container_name: core-policy
    environment:
      PORT: 4210
    networks:
      - adl-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "node -e \"fetch(\'http://localhost:4210/health\').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))\""]
      interval: 10s
      timeout: 5s
      retries: 5
    mem_limit: 256m
    cpus: 0.5
    volumes:
      - logs-data:/opt/adl-suite/logs
      - /opt/adl-suite/data/policy-engine:/opt/adl-suite/data/policy-engine
